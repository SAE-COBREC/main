\n\n-- 31. SEUILS DÉFINIS POUR COMPTES (vendeurs)\nINSERT INTO _definie_pour (id_seuil, id_compte) VALUES\n(1, 2), (2, 2), (3, 2), (4, 2), (5, 2),\n(1, 3), (2, 3), (3, 3), (5, 3),\n(1, 10), (2, 10), (3, 10), (4, 10), (5, 10),\n(5, 1)
\n\n-- ============================================\n-- MISES À JOUR DES STATISTIQUES\n-- ============================================\n\n-- Mise à jour des signalements sur produits\nUPDATE _produit SET p_nb_signalements = 1 WHERE id_produit = 1
\nUPDATE _produit SET p_nb_signalements = 1 WHERE id_produit = 12
\n\n-- Mise à jour du nombre de produits créés par les vendeurs\nUPDATE _vendeur SET nb_produits_crees = 10 WHERE id_vendeur = 1
\nUPDATE _vendeur SET nb_produits_crees = 8 WHERE id_vendeur = 2
\nUPDATE _vendeur SET nb_produits_crees = 7 WHERE id_vendeur = 3
\n\n-- Mise à jour de la moyenne des notes des produits ajoutés/modifiés/supprimés\n\nCREATE FUNCTION maj_moyenne_notes_produit_apres_insertion()\nRETURNS TRIGGER AS $$\nBEGIN\n    UPDATE cobrec1._produit\n    SET p_note = (\n        SELECT ROUND(AVG(p_note)::numeric,1)\n        FROM cobrec1._avis\n        WHERE id_produit = NEW.id_produit\n    )\n    WHERE id_produit = NEW.id_produit;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql
\n\nCREATE FUNCTION maj_moyenne_notes_produit_apres_modification()\nRETURNS TRIGGER AS $$\nBEGIN\n    UPDATE cobrec1._produit\n    SET p_note = (\n        SELECT ROUND(AVG(p_note)::numeric,1)\n        FROM cobrec1._avis\n        WHERE id_produit = NEW.id_produit\n    )\n    WHERE id_produit = NEW.id_produit;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql
\n\nCREATE FUNCTION maj_moyenne_notes_produit_apres_suppression()\nRETURNS TRIGGER AS $$\nBEGIN\n    UPDATE cobrec1._produit\n    SET p_note = (\n        SELECT ROUND(AVG(p_note)::numeric,1)\n        FROM cobrec1._avis\n        WHERE id_produit = OLD.id_produit\n    )\n    WHERE id_produit = OLD.id_produit;\n    RETURN OLD;\nEND;\n$$ LANGUAGE plpgsql
\n\nCREATE TRIGGER tgr_moyenne_notes_produit_apres_insertion\nAFTER INSERT on _avis\nFOR EACH ROW\nEXECUTE PROCEDURE maj_moyenne_notes_produit_apres_insertion()
\n\nCREATE TRIGGER tgr_moyenne_notes_produit_apres_modification\nAFTER UPDATE on _avis\nFOR EACH ROW\nEXECUTE PROCEDURE maj_moyenne_notes_produit_apres_modification()
\n\nCREATE TRIGGER tgr_moyenne_notes_produit_apres_suppression\nAFTER DELETE on _avis\nFOR EACH ROW\nEXECUTE PROCEDURE maj_moyenne_notes_produit_apres_suppression()
\n\n\nUPDATE cobrec1._produit SET p_note = 0
\nUPDATE cobrec1._commentaire SET a_note = 0.0
\n\n\n\nSELECT \n            DISTINCT ON (p.id_produit)\n            p.p_nom,\n            p.p_description,\n            p.p_prix,\n            p.p_stock,\n            p.p_note as note_moyenne,\n            p.p_nb_ventes,\n            p.p_statut,\n            COALESCE(r.reduction_pourcentage, 0) as pourcentage_reduction,\n            COALESCE(avis.nombre_avis, 0) as nombre_avis,\n            (SELECT STRING_AGG(cp.nom_categorie, ', ') \n                FROM _fait_partie_de fpd \n                JOIN _categorie_produit cp ON fpd.id_categorie = cp.id_categorie\n                WHERE fpd.id_produit = p.id_produit) as categories,\n            (SELECT i.i_lien \n                FROM _represente_produit rp \n                JOIN _image i ON rp.id_image = i.id_image\n                WHERE rp.id_produit = p.id_produit \n                LIMIT 1) as image_url\n        FROM _produit p\n        LEFT JOIN _en_reduction er ON p.id_produit = er.id_produit\n        LEFT JOIN _reduction r ON er.id_reduction = r.id_reduction \n        LEFT JOIN (\n            SELECT id_produit, COUNT(*) as nombre_avis \n            FROM _avis \n            GROUP BY id_produit\n        ) avis ON p.id_produit = avis.id_produit WHERE p.p_statut = 'En ligne'
