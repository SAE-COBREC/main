\n\nALTER TABLE ONLY cobrec1._signale_avis\n    ADD CONSTRAINT fk_signale_avis_avis FOREIGN KEY (id_avis) \n            REFERENCES cobrec1._avis(id_avis) ON DELETE CASCADE
\n\n-- TABLE ENVOIE_SIGNALEMENT\nCREATE TABLE cobrec1._envoie_signalement (\n    id_compte integer NOT NULL,\n    id_signalement integer NOT NULL\n)
\n\nALTER TABLE ONLY cobrec1._envoie_signalement\n    ADD CONSTRAINT pk_envoie_signalement PRIMARY KEY (id_compte, id_signalement)
\n\nALTER TABLE ONLY cobrec1._envoie_signalement\n    ADD CONSTRAINT fk_envoie_signalement_compte FOREIGN KEY (id_compte) \n            REFERENCES cobrec1._compte(id_compte) ON DELETE CASCADE
\n\nALTER TABLE ONLY cobrec1._envoie_signalement\n    ADD CONSTRAINT fk_envoie_signalement_signalement FOREIGN KEY (id_signalement) \n            REFERENCES cobrec1._signalement(id_signalement) ON DELETE CASCADE
\n\n-- TABLE DEFINIE_POUR\nCREATE TABLE cobrec1._definie_pour (\n    id_seuil integer NOT NULL,\n    id_compte integer NOT NULL\n)
\n\nALTER TABLE ONLY cobrec1._definie_pour\n    ADD CONSTRAINT pk_definie_pour PRIMARY KEY (id_seuil, id_compte)
\n\nALTER TABLE ONLY cobrec1._definie_pour\n    ADD CONSTRAINT fk_definie_pour_seuil FOREIGN KEY (id_seuil) \n            REFERENCES cobrec1._seuil_alerte(id_seuil) ON DELETE CASCADE
\n\nALTER TABLE ONLY cobrec1._definie_pour\n    ADD CONSTRAINT fk_definie_pour_compte FOREIGN KEY (id_compte) \n            REFERENCES cobrec1._compte(id_compte) ON DELETE CASCADE
\n\n\n-- ============================================\n-- FONCTIONS ET TRIGGERS\n-- ============================================\nCREATE FUNCTION maj_moyenne_notes_produit_apres_insertion()\nRETURNS TRIGGER AS $$\nBEGIN\n    UPDATE cobrec1._produit\n    SET p_note = (\n        SELECT ROUND(AVG(p_note)::numeric,1)\n        FROM cobrec1._avis\n        WHERE id_produit = NEW.id_produit\n    )\n    WHERE id_produit = NEW.id_produit;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql
\n\nCREATE FUNCTION maj_moyenne_notes_produit_apres_modification()\nRETURNS TRIGGER AS $$\nBEGIN\n    UPDATE cobrec1._produit\n    SET p_note = (\n        SELECT ROUND(AVG(p_note)::numeric,1)\n        FROM cobrec1._avis\n        WHERE id_produit = NEW.id_produit\n    )\n    WHERE id_produit = NEW.id_produit;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql
\n\nCREATE FUNCTION maj_moyenne_notes_produit_apres_suppression()\nRETURNS TRIGGER AS $$\nBEGIN\n    UPDATE cobrec1._produit\n    SET p_note = (\n        SELECT ROUND(AVG(p_note)::numeric,1)\n        FROM cobrec1._avis\n        WHERE id_produit = OLD.id_produit\n    )\n    WHERE id_produit = OLD.id_produit;\n    RETURN OLD;\nEND;\n$$ LANGUAGE plpgsql
\n\nCREATE TRIGGER tgr_moyenne_notes_produit_apres_insertion\nAFTER INSERT on _avis\nFOR EACH ROW\nEXECUTE PROCEDURE maj_moyenne_notes_produit_apres_insertion()
\n\nCREATE TRIGGER tgr_moyenne_notes_produit_apres_modification\nAFTER UPDATE on _avis\nFOR EACH ROW\nEXECUTE PROCEDURE maj_moyenne_notes_produit_apres_modification()
\n\nCREATE TRIGGER tgr_moyenne_notes_produit_apres_suppression\nAFTER DELETE on _avis\nFOR EACH ROW\nEXECUTE PROCEDURE maj_moyenne_notes_produit_apres_suppression()
