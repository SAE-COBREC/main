\nUPDATE _produit SET p_nb_signalements = 1 WHERE id_produit = 12
\n\n-- Mise à jour du nombre de produits créés par les vendeurs\nUPDATE _vendeur SET nb_produits_crees = 10 WHERE id_vendeur = 1
\nUPDATE _vendeur SET nb_produits_crees = 8 WHERE id_vendeur = 2
\nUPDATE _vendeur SET nb_produits_crees = 7 WHERE id_vendeur = 3
\n\n-- Mise à jour de la moyenne des notes des produits ajoutés/modifiés/supprimés\n\nUPDATE cobrec1._produit SET p_note = 0
\nUPDATE cobrec1._commentaire SET a_note = 0.0
\n\n\nSELECT DISTINCT ON (p.id_produit)\n            p.id_produit,\n            p.p_nom,\n            p.p_description,\n            p.p_prix,\n            p.p_stock,\n            r.reduction_pourcentage,\n            (SELECT COUNT(*) FROM cobrec1._avis av2 WHERE av2.id_produit = p.id_produit AND av2.a_note IS NOT NULL) as nombre_avis,\n            (SELECT ROUND(COALESCE(AVG(av3.a_note), 0)::numeric, 1) FROM cobrec1._avis av3 WHERE av3.id_produit = p.id_produit AND av3.a_note IS NOT NULL) as note_moyenne,\n            (SELECT COALESCE(i2.i_lien, '/img/photo/smartphone_xpro.jpg') FROM cobrec1._represente_produit rp2 LEFT JOIN cobrec1._image i2 ON rp2.id_image = i2.id_image WHERE rp2.id_produit = p.id_produit LIMIT 1) as image_url,\n            STRING_AGG(DISTINCT cp.nom_categorie, ', ') as categories\n        FROM cobrec1._produit p\n        LEFT JOIN cobrec1._reduction r ON p.id_produit = r.id_produit \n        LEFT JOIN cobrec1._tva t ON p.id_tva = t.id_tva\n        LEFT JOIN cobrec1._fait_partie_de fpd ON p.id_produit = fpd.id_produit\n        LEFT JOIN cobrec1._categorie_produit cp ON fpd.id_categorie = cp.id_categorie\n        WHERE p.p_statut = 'En ligne'\n        GROUP BY p.id_produit, p.p_nom, p.p_description, p.p_prix, p.p_stock, \n                 p.p_note, p.p_nb_ventes, p.p_statut, r.reduction_pourcentage, \n                 t.montant_tva\n        ORDER BY p.id_produit
\n\n\nSELECT DISTINCT ON (p.id_produit)\n            p.id_produit,\n            p.p_nom,\n            p.p_description,\n            p.p_prix,\n            p.p_stock,\n            r.reduction_pourcentage,\n            \n            (SELECT COUNT(*) FROM cobrec1._avis av2 WHERE av2.id_produit = p.id_produit AND av2.a_note IS NOT NULL) as nombre_avis,\n            (SELECT ROUND(COALESCE(AVG(av3.a_note), 0)::numeric, 1) FROM cobrec1._avis av3 WHERE av3.id_produit = p.id_produit AND av3.a_note IS NOT NULL) as note_moyenne,\n            (SELECT COALESCE(i2.i_lien, '/img/photo/smartphone_xpro.jpg') FROM cobrec1._represente_produit rp2 LEFT JOIN cobrec1._image i2 ON rp2.id_image = i2.id_image WHERE rp2.id_produit = p.id_produit LIMIT 1) as image_url,\n            STRING_AGG(DISTINCT cp.nom_categorie, ', ') as categories\n        FROM cobrec1._produit p\n        JOIN cobrec1._reduction r ON p.id_produit = r.id_produit \n        JOIN cobrec1._promotion ON p.id_produit = _promotion.id_produit \n        JOIN cobrec1._tva t ON p.id_tva = t.id_tva\n        JOIN cobrec1._fait_partie_de fpd ON p.id_produit = fpd.id_produit\n        JOIN cobrec1._categorie_produit cp ON fpd.id_categorie = cp.id_categorie\n        WHERE p.p_statut = 'En ligne'\n        GROUP BY p.id_produit, p.p_nom, p.p_description, p.p_prix, p.p_stock, \n                 p.p_note, p.p_nb_ventes, p.p_statut, r.reduction_pourcentage, \n                 t.montant_tva\n        ORDER BY p.id_produit
\n\n\nSELECT DISTINCT ON (p.id_produit)\n            p.id_produit,\n            p.p_nom,\n            p.p_description,\n            p.p_prix,\n            p.p_stock,\n            r.reduction_pourcentage,\n            \n            (SELECT COUNT(*) FROM cobrec1._avis av2 WHERE av2.id_produit = p.id_produit AND av2.a_note IS NOT NULL) as nombre_avis,\n            (SELECT ROUND(COALESCE(AVG(av3.a_note), 0)::numeric, 1) FROM cobrec1._avis av3 WHERE av3.id_produit = p.id_produit AND av3.a_note IS NOT NULL) as note_moyenne,\n            (SELECT COALESCE(i2.i_lien, '/img/photo/smartphone_xpro.jpg') FROM cobrec1._represente_produit rp2 LEFT JOIN cobrec1._image i2 ON rp2.id_image = i2.id_image WHERE rp2.id_produit = p.id_produit LIMIT 1) as image_url,\n            STRING_AGG(DISTINCT cp.nom_categorie, ', ') as categories\n        FROM cobrec1._produit p\n        LEFT JOIN cobrec1._reduction r ON p.id_produit = r.id_produit \n        LEFT JOIN cobrec1._promotion ON p.id_produit = _promotion.id_produit \n        LEFT JOIN cobrec1._tva t ON p.id_tva = t.id_tva\n        LEFT JOIN cobrec1._fait_partie_de fpd ON p.id_produit = fpd.id_produit\n        LEFT JOIN cobrec1._categorie_produit cp ON fpd.id_categorie = cp.id_categorie\n        WHERE p.p_statut = 'En ligne'\n        GROUP BY p.id_produit, p.p_nom, p.p_description, p.p_prix, p.p_stock, \n                 p.p_note, p.p_nb_ventes, p.p_statut, r.reduction_pourcentage, \n                 t.montant_tva\n        ORDER BY p.id_produit
\n\n\nSELECT DISTINCT ON (p.id_produit)\n            p.id_produit,\n            p.p_nom,\n            p.p_description,\n            p.p_prix,\n            p.p_stock,\n            r.reduction_pourcentage,\n            _promotion.id_produit,\n            (SELECT COUNT(*) FROM cobrec1._avis av2 WHERE av2.id_produit = p.id_produit AND av2.a_note IS NOT NULL) as nombre_avis,\n            (SELECT ROUND(COALESCE(AVG(av3.a_note), 0)::numeric, 1) FROM cobrec1._avis av3 WHERE av3.id_produit = p.id_produit AND av3.a_note IS NOT NULL) as note_moyenne,\n            (SELECT COALESCE(i2.i_lien, '/img/photo/smartphone_xpro.jpg') FROM cobrec1._represente_produit rp2 LEFT JOIN cobrec1._image i2 ON rp2.id_image = i2.id_image WHERE rp2.id_produit = p.id_produit LIMIT 1) as image_url,\n            STRING_AGG(DISTINCT cp.nom_categorie, ', ') as categories\n        FROM cobrec1._produit p\n        LEFT JOIN cobrec1._reduction r ON p.id_produit = r.id_produit \n        LEFT JOIN cobrec1._promotion ON p.id_produit = _promotion.id_produit \n        LEFT JOIN cobrec1._tva t ON p.id_tva = t.id_tva\n        LEFT JOIN cobrec1._fait_partie_de fpd ON p.id_produit = fpd.id_produit\n        LEFT JOIN cobrec1._categorie_produit cp ON fpd.id_categorie = cp.id_categorie\n        WHERE p.p_statut = 'En ligne'\n        GROUP BY p.id_produit, p.p_nom, p.p_description, p.p_prix, p.p_stock, \n                 p.p_note, p.p_nb_ventes, p.p_statut, r.reduction_pourcentage, \n                 t.montant_tva\n        ORDER BY p.id_produit
\n\n\nSELECT DISTINCT ON (p.id_produit)\n            p.id_produit,\n            p.p_nom,\n            p.p_description,\n            p.p_prix,\n            p.p_stock,\n            r.reduction_pourcentage,\n            promotion.id_produit,\n            (SELECT COUNT(*) FROM cobrec1._avis av2 WHERE av2.id_produit = p.id_produit AND av2.a_note IS NOT NULL) as nombre_avis,\n            (SELECT ROUND(COALESCE(AVG(av3.a_note), 0)::numeric, 1) FROM cobrec1._avis av3 WHERE av3.id_produit = p.id_produit AND av3.a_note IS NOT NULL) as note_moyenne,\n            (SELECT COALESCE(i2.i_lien, '/img/photo/smartphone_xpro.jpg') FROM cobrec1._represente_produit rp2 LEFT JOIN cobrec1._image i2 ON rp2.id_image = i2.id_image WHERE rp2.id_produit = p.id_produit LIMIT 1) as image_url,\n            STRING_AGG(DISTINCT cp.nom_categorie, ', ') as categories\n        FROM cobrec1._produit p\n        LEFT JOIN cobrec1._reduction r ON p.id_produit = r.id_produit \n        LEFT JOIN cobrec1._promotion ON p.id_produit = _promotion.id_produit \n        LEFT JOIN cobrec1._tva t ON p.id_tva = t.id_tva\n        LEFT JOIN cobrec1._fait_partie_de fpd ON p.id_produit = fpd.id_produit\n        LEFT JOIN cobrec1._categorie_produit cp ON fpd.id_categorie = cp.id_categorie\n        WHERE p.p_statut = 'En ligne'\n        GROUP BY p.id_produit, p.p_nom, p.p_description, p.p_prix, p.p_stock, \n                 p.p_note, p.p_nb_ventes, p.p_statut, r.reduction_pourcentage, \n                 t.montant_tva\n        ORDER BY p.id_produit
\n\n\nSELECT DISTINCT ON (p.id_produit)\n            p.id_produit,\n            p.p_nom,\n            p.p_description,\n            p.p_prix,\n            p.p_stock,\n            r.reduction_pourcentage,\n            pr.id_produit,\n            (SELECT COUNT(*) FROM cobrec1._avis av2 WHERE av2.id_produit = p.id_produit AND av2.a_note IS NOT NULL) as nombre_avis,\n            (SELECT ROUND(COALESCE(AVG(av3.a_note), 0)::numeric, 1) FROM cobrec1._avis av3 WHERE av3.id_produit = p.id_produit AND av3.a_note IS NOT NULL) as note_moyenne,\n            (SELECT COALESCE(i2.i_lien, '/img/photo/smartphone_xpro.jpg') FROM cobrec1._represente_produit rp2 LEFT JOIN cobrec1._image i2 ON rp2.id_image = i2.id_image WHERE rp2.id_produit = p.id_produit LIMIT 1) as image_url,\n            STRING_AGG(DISTINCT cp.nom_categorie, ', ') as categories\n        FROM cobrec1._produit p\n        LEFT JOIN cobrec1._reduction r ON p.id_produit = r.id_produit \n        LEFT JOIN cobrec1._promotion pr ON p.id_produit = pr.id_produit \n        LEFT JOIN cobrec1._tva t ON p.id_tva = t.id_tva\n        LEFT JOIN cobrec1._fait_partie_de fpd ON p.id_produit = fpd.id_produit\n        LEFT JOIN cobrec1._categorie_produit cp ON fpd.id_categorie = cp.id_categorie\n        WHERE p.p_statut = 'En ligne'\n        GROUP BY p.id_produit, p.p_nom, p.p_description, p.p_prix, p.p_stock, \n                 p.p_note, p.p_nb_ventes, p.p_statut, r.reduction_pourcentage, \n                 t.montant_tva\n        ORDER BY p.id_produit
\n\n\nSELECT DISTINCT ON (p.id_produit)\n    p.id_produit,\n    p.p_nom,\n    p.p_description,\n    p.p_prix,\n    p.p_stock,\n    r.reduction_pourcentage,\n    pr.id_produit,\n    (SELECT COUNT(*) FROM cobrec1._avis av2 WHERE av2.id_produit = p.id_produit AND av2.a_note IS NOT NULL) as nombre_avis,\n    (SELECT ROUND(COALESCE(AVG(av3.a_note), 0)::numeric, 1) FROM cobrec1._avis av3 WHERE av3.id_produit = p.id_produit AND av3.a_note IS NOT NULL) as note_moyenne,\n    (SELECT COALESCE(i2.i_lien, '/img/photo/smartphone_xpro.jpg') FROM cobrec1._represente_produit rp2 LEFT JOIN cobrec1._image i2 ON rp2.id_image = i2.id_image WHERE rp2.id_produit = p.id_produit LIMIT 1) as image_url,\n    STRING_AGG(DISTINCT cp.nom_categorie, ', ') as categories\nFROM cobrec1._produit p\nLEFT JOIN cobrec1._reduction r ON p.id_produit = r.id_produit \nLEFT JOIN cobrec1._promotion pr ON p.id_produit = pr.id_produit \nLEFT JOIN cobrec1._tva t ON p.id_tva = t.id_tva\nLEFT JOIN cobrec1._fait_partie_de fpd ON p.id_produit = fpd.id_produit\nLEFT JOIN cobrec1._categorie_produit cp ON fpd.id_categorie = cp.id_categorie\nWHERE p.p_statut = 'En ligne'\nGROUP BY p.id_produit, p.p_nom, p.p_description, p.p_prix, p.p_stock, \n         p.p_note, p.p_nb_ventes, p.p_statut, r.reduction_pourcentage, \n         pr.id_produit, t.montant_tva\nORDER BY p.id_produit
\n\n\nSELECT DISTINCT ON (p.id_produit)\n    p.id_produit,\n    p.p_nom,\n    p.p_description,\n    p.p_prix,\n    p.p_stock,\n    r.reduction_pourcentage,\n    pr.id_produit as estEnpromo,\n    (SELECT COUNT(*) FROM cobrec1._avis av2 WHERE av2.id_produit = p.id_produit AND av2.a_note IS NOT NULL) as nombre_avis,\n    (SELECT ROUND(COALESCE(AVG(av3.a_note), 0)::numeric, 1) FROM cobrec1._avis av3 WHERE av3.id_produit = p.id_produit AND av3.a_note IS NOT NULL) as note_moyenne,\n    (SELECT COALESCE(i2.i_lien, '/img/photo/smartphone_xpro.jpg') FROM cobrec1._represente_produit rp2 LEFT JOIN cobrec1._image i2 ON rp2.id_image = i2.id_image WHERE rp2.id_produit = p.id_produit LIMIT 1) as image_url,\n    STRING_AGG(DISTINCT cp.nom_categorie, ', ') as categories\nFROM cobrec1._produit p\nLEFT JOIN cobrec1._reduction r ON p.id_produit = r.id_produit \nLEFT JOIN cobrec1._promotion pr ON p.id_produit = pr.id_produit \nLEFT JOIN cobrec1._tva t ON p.id_tva = t.id_tva\nLEFT JOIN cobrec1._fait_partie_de fpd ON p.id_produit = fpd.id_produit\nLEFT JOIN cobrec1._categorie_produit cp ON fpd.id_categorie = cp.id_categorie\nWHERE p.p_statut = 'En ligne'\nGROUP BY p.id_produit, p.p_nom, p.p_description, p.p_prix, p.p_stock, \n         p.p_note, p.p_nb_ventes, p.p_statut, r.reduction_pourcentage, \n         pr.id_produit, t.montant_tva\nORDER BY p.id_produit
SELECT DISTINCT ON (p.id_produit)\n    p.id_produit,\n    p.p_nom,\n    p.p_description,\n    p.p_prix,\n    p.p_stock,\n    r.reduction_pourcentage,\n    pr.id_produit as estEnpromo,\n    (SELECT COUNT(*) FROM cobrec1._avis av2 WHERE av2.id_produit = p.id_produit AND av2.a_note IS NOT NULL) as nombre_avis,\n    (SELECT ROUND(COALESCE(AVG(av3.a_note), 0)::numeric, 1) FROM cobrec1._avis av3 WHERE av3.id_produit = p.id_produit AND av3.a_note IS NOT NULL) as note_moyenne,\n    (SELECT COALESCE(i2.i_lien, '/img/photo/smartphone_xpro.jpg') FROM cobrec1._represente_produit rp2 LEFT JOIN cobrec1._image i2 ON rp2.id_image = i2.id_image WHERE rp2.id_produit = p.id_produit LIMIT 1) as image_url,\n    STRING_AGG(DISTINCT cp.nom_categorie, ', ') as categories\nFROM cobrec1._produit p\nLEFT JOIN cobrec1._reduction r ON p.id_produit = r.id_produit \nLEFT JOIN cobrec1._promotion pr ON p.id_produit = pr.id_produit \nLEFT JOIN cobrec1._tva t ON p.id_tva = t.id_tva\nLEFT JOIN cobrec1._fait_partie_de fpd ON p.id_produit = fpd.id_produit\nLEFT JOIN cobrec1._categorie_produit cp ON fpd.id_categorie = cp.id_categorie\nWHERE p.p_statut = 'En ligne'\nGROUP BY p.id_produit, p.p_nom, p.p_description, p.p_prix, p.p_stock, \n         p.p_note, p.p_nb_ventes, p.p_statut, r.reduction_pourcentage, \n         pr.id_produit, t.montant_tva\nORDER BY p.id_produit
